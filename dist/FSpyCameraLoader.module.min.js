import{Vector2 as t,Matrix4 as a,Vector3 as e,MathUtils as i,FileLoader as n,Loader as r,PerspectiveCamera as s}from"three";var o=function(t,a){return(o=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,a){t.__proto__=a}||function(t,a){for(var e in a)a.hasOwnProperty(e)&&(t[e]=a[e])})(t,a)};var h=1,l=50,m=1,g=function(){function n(){this.rawData=null,this.data=null,this.internalImageRatio=h,this.internalCameraFov=l,this.internalOriginalImageSize=new t,this.internalCameraTransformMatrix=new a,this.internalViewTransformMatrix=new a,this.internalCameraPosition=new e,this.internalIsSetData=!1}return n.prototype.setData=function(t){this.internalIsSetData=!0,this.rawData=t,this.onSetData()},n.prototype.removeData=function(){this.internalIsSetData=!1,this.rawData=null,this.onRemoveData()},n.prototype.getData=function(){return this.rawData},n.prototype.getComputedData=function(){return this.data},n.prototype.setComputedData=function(){null!=this.rawData&&(this.data={},this.data.principalPoint=new t(this.rawData.principalPoint.x,this.rawData.principalPoint.y),this.data.viewTransform=this.internalViewTransformMatrix,this.data.cameraTransform=this.internalCameraTransformMatrix,this.data.horizontalFieldOfView=this.rawData.horizontalFieldOfView,this.data.verticalFieldOfView=this.rawData.verticalFieldOfView,this.data.vanishingPoints=[new t(this.rawData.vanishingPoints[0].x,this.rawData.vanishingPoints[0].y),new t(this.rawData.vanishingPoints[1].x,this.rawData.vanishingPoints[1].y),new t(this.rawData.vanishingPoints[2].x,this.rawData.vanishingPoints[2].y)],this.data.vanishingPointAxes=[this.rawData.vanishingPointAxes[0],this.rawData.vanishingPointAxes[1],this.rawData.vanishingPointAxes[2]],this.data.relativeFocalLength=this.rawData.relativeFocalLength,this.data.imageWidth=this.rawData.imageWidth,this.data.imageHeight=this.rawData.imageHeight,this.data.imageSize=this.internalOriginalImageSize,this.data.imageRatio=this.internalImageRatio,this.data.cameraPosition=this.internalCameraPosition,this.data.cameraFov=this.internalCameraFov)},n.prototype.onSetData=function(){this.internalImageRatio=this.calcImageRatio(),null!=this.rawData&&(this.internalOriginalImageSize=new t(this.rawData.imageWidth,this.rawData.imageHeight),this.internalCameraFov=this.getVFovDegFromRad(this.rawData.verticalFieldOfView),this.setTransformMatrix(this.rawData.cameraTransform.rows,this.internalCameraTransformMatrix),this.setTransformMatrix(this.rawData.viewTransform.rows,this.internalViewTransformMatrix),this.setCameraPosition(),this.setComputedData())},n.prototype.onRemoveData=function(){this.internalImageRatio=h,this.internalCameraFov=l,this.internalOriginalImageSize=new t,this.internalCameraTransformMatrix=new a,this.internalViewTransformMatrix=new a,this.internalCameraPosition=new e,this.data=null},n.prototype.calcImageRatio=function(){return null!=this.rawData?this.rawData.imageWidth/this.rawData.imageHeight:h},n.prototype.getVFovDegFromRad=function(t){return i.radToDeg(t)},n.prototype.setTransformMatrix=function(t,e){if(null!=this.rawData){var i=t.reduce((function(t,a){return t.push.apply(t,a),t}),[]);return e.elements=i,e}return new a},n.prototype.setCameraPosition=function(){if(null!=this.rawData){var t=this.rawData.cameraTransform.rows;this.internalCameraPosition=new e(t[0][3],t[1][3],t[2][3])}},Object.defineProperty(n.prototype,"imageRatio",{get:function(){return this.internalImageRatio},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"rotationMatrix",{get:function(){return this.cameraMatrix},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"cameraMatrix",{get:function(){return this.internalCameraTransformMatrix},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"viewMatrix",{get:function(){return this.internalViewTransformMatrix},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"cameraFov",{get:function(){return this.internalCameraFov},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"cameraPosition",{get:function(){return this.internalCameraPosition},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"isSetData",{get:function(){return this.internalIsSetData},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"imageSize",{get:function(){return this.internalOriginalImageSize},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"imageWidth",{get:function(){return this.internalOriginalImageSize.width},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"imageHeight",{get:function(){return this.internalOriginalImageSize.height},enumerable:!0,configurable:!0}),n}(),c=function(a){function e(e){var i=a.call(this)||this;return r.call(i,e),i.targetCanvas=null,i.targetCanvasSize=new t,i.camera=new s,i.dataManager=new g,i}return function(t,a){function e(){this.constructor=t}o(t,a),t.prototype=null===a?Object.create(a):(e.prototype=a.prototype,new e)}(e,a),e.prototype.load=function(t,a,e,i){var r=this,s=new n(this.manager);s.setPath(this.path),s.setResponseType("json"),s.load(t,(function(t){a(r.parse(t))}),e,i)},e.prototype.parse=function(t){return this.dataManager.setData(t),this.createCamera()},e.prototype.setCanvas=function(t){this.targetCanvas=t},e.prototype.removeCanvas=function(){this.targetCanvas=null},e.prototype.setResizeUpdate=function(){window.addEventListener("resize",this.onResize.bind(this))},e.prototype.removeResizeupdate=function(){window.removeEventListener("resize",this.onResize.bind(this))},e.prototype.createCamera=function(){return this.dataManager.isSetData&&(this.camera.fov=this.dataManager.cameraFov,null!=this.targetCanvasSize?this.camera.aspect=this.targetCanvasSize.x/this.targetCanvasSize.y:this.camera.aspect=this.dataManager.imageRatio,this.camera.position.set(this.dataManager.cameraPosition.x,this.dataManager.cameraPosition.y,this.dataManager.cameraPosition.z),this.camera.setRotationFromMatrix(this.dataManager.rotationMatrix),this.onResize()),this.camera},e.prototype.onResize=function(){if(null!=this.targetCanvas){var t=this.targetCanvas.getBoundingClientRect(),a=this.dataManager.imageRatio;this.targetCanvasSize.setX(t.width),this.targetCanvasSize.setY(t.height),this.targetCanvasSize.x/this.targetCanvasSize.y<=a?(this.camera.aspect=this.targetCanvasSize.x/this.targetCanvasSize.y,this.camera.zoom=m):(this.camera.aspect=this.targetCanvasSize.x/this.targetCanvasSize.y,this.camera.zoom=this.targetCanvasSize.x/this.targetCanvasSize.y/a),this.camera.updateProjectionMatrix()}},e}(r);export default c;
