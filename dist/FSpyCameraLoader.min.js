!function(t,a){"object"==typeof exports&&"undefined"!=typeof module?module.exports=a(require("three")):"function"==typeof define&&define.amd?define(["three"],a):(t=t||self).FSpyCamera=a(t.THREE)}(this,(function(t){"use strict";var a=function(t,e){return(a=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,a){t.__proto__=a}||function(t,a){for(var e in a)a.hasOwnProperty(e)&&(t[e]=a[e])})(t,e)};var e=1,i=50,r=1,n=function(){function a(){this.rawData=null,this.data=null,this.internalImageRatio=e,this.internalCameraFov=i,this.internalOriginalImageSize=new t.Vector2,this.internalCameraTransformMatrix=new t.Matrix4,this.internalViewTransformMatrix=new t.Matrix4,this.internalCameraPosition=new t.Vector3,this.internalIsSetData=!1}return a.prototype.setData=function(t){this.internalIsSetData=!0,this.rawData=t,this.onSetData()},a.prototype.removeData=function(){this.internalIsSetData=!1,this.rawData=null,this.onRemoveData()},a.prototype.getData=function(){return this.rawData},a.prototype.getComputedData=function(){return this.data},a.prototype.setComputedData=function(){null!=this.rawData&&(this.data={},this.data.principalPoint=new t.Vector2(this.rawData.principalPoint.x,this.rawData.principalPoint.y),this.data.viewTransform=this.internalViewTransformMatrix,this.data.cameraTransform=this.internalCameraTransformMatrix,this.data.horizontalFieldOfView=this.rawData.horizontalFieldOfView,this.data.verticalFieldOfView=this.rawData.verticalFieldOfView,this.data.vanishingPoints=[new t.Vector2(this.rawData.vanishingPoints[0].x,this.rawData.vanishingPoints[0].y),new t.Vector2(this.rawData.vanishingPoints[1].x,this.rawData.vanishingPoints[1].y),new t.Vector2(this.rawData.vanishingPoints[2].x,this.rawData.vanishingPoints[2].y)],this.data.vanishingPointAxes=[this.rawData.vanishingPointAxes[0],this.rawData.vanishingPointAxes[1],this.rawData.vanishingPointAxes[2]],this.data.relativeFocalLength=this.rawData.relativeFocalLength,this.data.imageWidth=this.rawData.imageWidth,this.data.imageHeight=this.rawData.imageHeight,this.data.imageSize=this.internalOriginalImageSize,this.data.imageRatio=this.internalImageRatio,this.data.cameraPosition=this.internalCameraPosition,this.data.cameraFov=this.internalCameraFov)},a.prototype.onSetData=function(){this.internalImageRatio=this.calcImageRatio(),null!=this.rawData&&(this.internalOriginalImageSize=new t.Vector2(this.rawData.imageWidth,this.rawData.imageHeight),this.internalCameraFov=this.getVFovDegFromRad(this.rawData.verticalFieldOfView),this.setTransformMatrix(this.rawData.cameraTransform.rows,this.internalCameraTransformMatrix),this.setTransformMatrix(this.rawData.viewTransform.rows,this.internalViewTransformMatrix),this.setCameraPosition(),this.setComputedData())},a.prototype.onRemoveData=function(){this.internalImageRatio=e,this.internalCameraFov=i,this.internalOriginalImageSize=new t.Vector2,this.internalCameraTransformMatrix=new t.Matrix4,this.internalViewTransformMatrix=new t.Matrix4,this.internalCameraPosition=new t.Vector3,this.data=null},a.prototype.calcImageRatio=function(){return null!=this.rawData?this.rawData.imageWidth/this.rawData.imageHeight:e},a.prototype.getVFovDegFromRad=function(a){return t.MathUtils.radToDeg(a)},a.prototype.setTransformMatrix=function(a,e){if(null!=this.rawData){var i=a.reduce((function(t,a){return t.push.apply(t,a),t}),[]);return e.elements=i,e}return new t.Matrix4},a.prototype.setCameraPosition=function(){if(null!=this.rawData){var a=this.rawData.cameraTransform.rows;this.internalCameraPosition=new t.Vector3(a[0][3],a[1][3],a[2][3])}},Object.defineProperty(a.prototype,"imageRatio",{get:function(){return this.internalImageRatio},enumerable:!0,configurable:!0}),Object.defineProperty(a.prototype,"rotationMatrix",{get:function(){return this.cameraMatrix},enumerable:!0,configurable:!0}),Object.defineProperty(a.prototype,"cameraMatrix",{get:function(){return this.internalCameraTransformMatrix},enumerable:!0,configurable:!0}),Object.defineProperty(a.prototype,"viewMatrix",{get:function(){return this.internalViewTransformMatrix},enumerable:!0,configurable:!0}),Object.defineProperty(a.prototype,"cameraFov",{get:function(){return this.internalCameraFov},enumerable:!0,configurable:!0}),Object.defineProperty(a.prototype,"cameraPosition",{get:function(){return this.internalCameraPosition},enumerable:!0,configurable:!0}),Object.defineProperty(a.prototype,"isSetData",{get:function(){return this.internalIsSetData},enumerable:!0,configurable:!0}),Object.defineProperty(a.prototype,"imageSize",{get:function(){return this.internalOriginalImageSize},enumerable:!0,configurable:!0}),Object.defineProperty(a.prototype,"imageWidth",{get:function(){return this.internalOriginalImageSize.width},enumerable:!0,configurable:!0}),Object.defineProperty(a.prototype,"imageHeight",{get:function(){return this.internalOriginalImageSize.height},enumerable:!0,configurable:!0}),a}();return function(e){function i(a){var i=e.call(this)||this;return t.Loader.call(i,a),i.targetCanvas=null,i.targetCanvasSize=new t.Vector2,i.camera=new t.PerspectiveCamera,i.dataManager=new n,i}return function(t,e){function i(){this.constructor=t}a(t,e),t.prototype=null===e?Object.create(e):(i.prototype=e.prototype,new i)}(i,e),i.prototype.load=function(a,e,i,r){var n=this,o=new t.FileLoader(this.manager);o.setPath(this.path),o.setResponseType("json"),o.load(a,(function(t){e(n.parse(t))}),i,r)},i.prototype.parse=function(t){return this.dataManager.setData(t),this.createCamera()},i.prototype.setCanvas=function(t){this.targetCanvas=t},i.prototype.removeCanvas=function(){this.targetCanvas=null},i.prototype.setResizeUpdate=function(){window.addEventListener("resize",this.onResize.bind(this))},i.prototype.removeResizeupdate=function(){window.removeEventListener("resize",this.onResize.bind(this))},i.prototype.createCamera=function(){return this.dataManager.isSetData&&(this.camera.fov=this.dataManager.cameraFov,null!=this.targetCanvasSize?this.camera.aspect=this.targetCanvasSize.x/this.targetCanvasSize.y:this.camera.aspect=this.dataManager.imageRatio,this.camera.position.set(this.dataManager.cameraPosition.x,this.dataManager.cameraPosition.y,this.dataManager.cameraPosition.z),this.camera.setRotationFromMatrix(this.dataManager.rotationMatrix),this.onResize()),this.camera},i.prototype.onResize=function(){if(null!=this.targetCanvas){var t=this.targetCanvas.getBoundingClientRect(),a=this.dataManager.imageRatio;this.targetCanvasSize.setX(t.width),this.targetCanvasSize.setY(t.height),this.targetCanvasSize.x/this.targetCanvasSize.y<=a?(this.camera.aspect=this.targetCanvasSize.x/this.targetCanvasSize.y,this.camera.zoom=r):(this.camera.aspect=this.targetCanvasSize.x/this.targetCanvasSize.y,this.camera.zoom=this.targetCanvasSize.x/this.targetCanvasSize.y/a),this.camera.updateProjectionMatrix()}},i}(t.Loader)}));
